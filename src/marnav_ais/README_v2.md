# AIS Parser Node V2 - æ‰¹é‡å‘å¸ƒç‰ˆæœ¬

## ğŸ“ æ¦‚è¿°

AISè§£æèŠ‚ç‚¹V2ç‰ˆæœ¬ï¼Œä¸“æ³¨äºé«˜æ•ˆæ‰¹é‡å¤„ç†AIVDMæŠ¥æ–‡ã€‚ä¸åŸç‰ˆç›¸æ¯”ï¼Œä¸»è¦æ”¹è¿›ï¼š

- âœ… **æ‰¹é‡å‘å¸ƒ**ï¼šæ¯ç§’æ±‡æ€»å‘å¸ƒä¸Šä¸€ç§’å†…çš„æ‰€æœ‰AISæ•°æ®ï¼ˆ`AisBatch`æ ¼å¼ï¼‰
- âœ… **èšç„¦AIVDM**ï¼šä»…è§£æType 1/2/3ä½ç½®æŠ¥å‘Šï¼Œç§»é™¤RMC/GGAå¤„ç†
- âœ… **é«˜é²æ£’æ€§**ï¼šå¤šç‰‡æ®µç»„åˆã€æ•°æ®æ ¡éªŒã€ç¼“å­˜æº¢å‡ºä¿æŠ¤
- âœ… **ä¸‰æ¥å£æ”¯æŒ**ï¼šSerial/TCP/UDPå¯é…ç½®

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘

```bash
cd ~/RV
colcon build --packages-select marnav_ais
source install/setup.bash
```

### 2. é…ç½®å‚æ•°

åˆ›å»ºå‚æ•°æ–‡ä»¶ `config/ais_batch_params.yaml`ï¼ˆæˆ–ç›´æ¥åœ¨launchä¸­ä¿®æ”¹ï¼‰ï¼š

```yaml
ais_batch_parser:
  ros__parameters:
    # é€šä¿¡æ–¹å¼: serial / tcp / udp
    comm_type: "serial"
    
    # ä¸²å£é…ç½®
    serial_port: "/dev/ttyS3"
    baud_rate: 38400
    
    # TCPé…ç½®ï¼ˆå½“comm_type=tcpæ—¶ä½¿ç”¨ï¼‰
    tcp_ip: "127.0.0.1"
    tcp_port: 5000
    
    # UDPé…ç½®ï¼ˆå½“comm_type=udpæ—¶ä½¿ç”¨ï¼‰
    udp_ip: "0.0.0.0"
    udp_port: 1300
    
    # æ—¥å¿—é…ç½®
    log_directory: "/home/tl/RV/ais_logs"
    log_raw_data: false  # æ˜¯å¦è®°å½•åŸå§‹NMEAæ•°æ®
    
    # ç¼“å­˜é…ç½®
    max_cache_size: 1000  # æœ€å¤§ç¼“å­˜æ¡ç›®ï¼ˆé˜²æº¢å‡ºï¼‰
```

### 3. å¯åŠ¨èŠ‚ç‚¹

#### æ–¹å¼ä¸€ï¼šç›´æ¥è¿è¡Œ
```bash
ros2 run marnav_ais ais_parser_node_v2
```

#### æ–¹å¼äºŒï¼šå¸¦å‚æ•°è¿è¡Œ
```bash
ros2 run marnav_ais ais_parser_node_v2 \
  --ros-args \
  -p comm_type:=serial \
  -p serial_port:=/dev/ttyS3 \
  -p baud_rate:=38400
```

#### æ–¹å¼ä¸‰ï¼šä½¿ç”¨å‚æ•°æ–‡ä»¶
```bash
ros2 run marnav_ais ais_parser_node_v2 \
  --ros-args \
  --params-file config/ais_batch_params.yaml
```

## ğŸ“¡ è¯é¢˜æ¥å£

### å‘å¸ƒè¯é¢˜

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | é¢‘ç‡ | è¯´æ˜ |
|---------|---------|------|------|
| `/ais_batch_data` | `marnav_interfaces/msg/AisBatch` | 1Hz | æ‰¹é‡AISæ•°æ®ï¼ˆæ¯ç§’æ±‡æ€»ï¼‰ |

### æ¶ˆæ¯æ ¼å¼

**AisBatch.msg:**
```
marnav_interfaces/Ais[] ais_list      # å½“å‰æ‰¹æ¬¡çš„AISæ•°æ®åˆ—è¡¨
builtin_interfaces/Time batch_time    # æ‰¹æ¬¡å‘å¸ƒæ—¶é—´æˆ³
```

**Ais.msg:**
```
uint64 mmsi                           # èˆ¹èˆ¶MMSIå·
float64 lat                           # çº¬åº¦ï¼ˆåº¦ï¼‰
float64 lon                           # ç»åº¦ï¼ˆåº¦ï¼‰
float64 speed                         # å¯¹åœ°é€Ÿåº¦ï¼ˆèŠ‚ï¼‰
float64 course                        # å¯¹åœ°èˆªå‘ï¼ˆåº¦ï¼ŒçœŸåŒ—ï¼‰
float64 heading                       # èˆ¹é¦–å‘ï¼ˆåº¦ï¼ŒçœŸåŒ—ï¼‰
uint8 type                            # AISæ¶ˆæ¯ç±»å‹ï¼ˆ1/2/3ï¼‰
builtin_interfaces/Time timestamp     # æ¥æ”¶æ—¶é—´æˆ³
```

## ğŸ” åŠŸèƒ½ç‰¹æ€§

### 1. å¤šç‰‡æ®µç»„åˆ
è‡ªåŠ¨å¤„ç†è¢«æ‹†åˆ†çš„AIVDMæŠ¥æ–‡ï¼š
```
!AIVDM,2,1,0,A,56:btmP000030000001`PDQE`PuDQDwGK...,0*2D
!AIVDM,2,2,0,A,OP000164h<5500009f00000,0*1A
â†’ è‡ªåŠ¨ç»„åˆåè§£æ
```

### 2. æ•°æ®æ ¡éªŒ
- MMSIéé›¶æ£€æŸ¥
- ä½ç½®æ•°æ®æœ‰æ•ˆæ€§éªŒè¯
- å¯¼èˆªæ•°æ®ç¼ºå¤±å®¹é”™ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰

### 3. ç¼“å­˜ç®¡ç†
- æ¯ç§’æ¸…ç©ºä¸€æ¬¡ç¼“å­˜ï¼ˆæ‰¹é‡å‘å¸ƒåï¼‰
- æº¢å‡ºä¿æŠ¤ï¼ˆç§»é™¤æœ€æ—§æ•°æ®ï¼‰
- çº¿ç¨‹å®‰å…¨ï¼ˆmutexä¿æŠ¤ï¼‰

### 4. æ—¥å¿—ç³»ç»Ÿ
å¯é€‰çš„åŸå§‹NMEAæ•°æ®æ—¥å¿—ï¼ˆCSVæ ¼å¼ï¼‰ï¼š
```
UTCæ—¶é—´,ROSæ—¶é—´æˆ³,åŸå§‹NMEA
2025-01-09T10:15:30,1736416530.123456789,!AIVDM,1,1,,A,16:aUWU00R8cRIRAs>IqS@0@0000,0*3A
```

## ğŸ› ï¸ è°ƒè¯•ä¸ç›‘æ§

### æŸ¥çœ‹æ‰¹é‡æ•°æ®
```bash
ros2 topic echo /ais_batch_data
```

### æŸ¥çœ‹å‘å¸ƒé¢‘ç‡
```bash
ros2 topic hz /ais_batch_data
```

### æŸ¥çœ‹æ‰¹æ¬¡ç»Ÿè®¡
```bash
ros2 topic echo /ais_batch_data --field ais_list
# æˆ–æŸ¥çœ‹æ‰¹æ¬¡å¤§å°
ros2 topic echo /ais_batch_data | grep -c "mmsi:"
```

### æ—¥å¿—çº§åˆ«è°ƒæ•´
```bash
# DEBUGçº§åˆ«ï¼ˆæ˜¾ç¤ºè¯¦ç»†è§£æä¿¡æ¯ï¼‰
ros2 run marnav_ais ais_parser_node_v2 --ros-args --log-level debug

# INFOçº§åˆ«ï¼ˆä»…æ˜¾ç¤ºæ‰¹é‡å‘å¸ƒä¿¡æ¯ï¼‰
ros2 run marnav_ais ais_parser_node_v2 --ros-args --log-level info
```

## ğŸ“Š æ€§èƒ½è¯´æ˜

- **ç¼“å­˜å®¹é‡**ï¼šé»˜è®¤1000æ¡ï¼ˆå¯é…ç½®`max_cache_size`ï¼‰
- **å‘å¸ƒé¢‘ç‡**ï¼šå›ºå®š1Hz
- **å¤„ç†å»¶è¿Ÿ**ï¼š< 1ç§’ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰
- **å†…å­˜å ç”¨**ï¼šçº¦ 5-20MBï¼ˆå–å†³äºç¼“å­˜å¤§å°ï¼‰

### é«˜è´Ÿè½½åœºæ™¯
è‹¥AISæ•°æ®æµé‡æå¤§ï¼ˆ>1000æ¡/ç§’ï¼‰ï¼Œå»ºè®®ï¼š
1. å¢åŠ  `max_cache_size` å‚æ•°
2. ç›‘æ§æ—¥å¿—ä¸­çš„"ç¼“å­˜æº¢å‡º"è­¦å‘Š
3. è€ƒè™‘ä½¿ç”¨æ›´å¿«çš„åºåˆ—åŒ–æ–¹å¼

## ğŸ”„ ä¸åŸç‰ˆå¯¹æ¯”

| ç‰¹æ€§ | åŸç‰ˆ (v1) | V2ç‰ˆ (æ‰¹é‡) |
|------|-----------|-------------|
| RMCè§£æ | âœ… | âŒ |
| GGAè§£æ | âœ… | âŒ |
| AIVDMè§£æ | âœ… | âœ… |
| å‘å¸ƒæ¨¡å¼ | å®æ—¶ï¼ˆæ”¶åˆ°å³å‘ï¼‰ | æ‰¹é‡ï¼ˆ1Hzï¼‰ |
| æ¶ˆæ¯æ ¼å¼ | `Ais` | `AisBatch` |
| æ•°æ®ç¼“å­˜ | æ—  | âœ… deque |
| é€‚ç”¨åœºæ™¯ | å®æ—¶æ€§è¦æ±‚é«˜ | æ•°æ®åˆ†æ/æ‰¹å¤„ç† |

## âš™ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ‰¹é‡å‘å¸ƒé—´éš”ä¸º1ç§’ï¼Ÿ
**A:** å¹³è¡¡å®æ—¶æ€§ä¸æ•°æ®å®Œæ•´æ€§ã€‚è‹¥éœ€æ›´å¿«ï¼Œå¯ä¿®æ”¹å®šæ—¶å™¨ï¼š
```cpp
// æ”¹ä¸º500mså‘å¸ƒä¸€æ¬¡
publish_timer_ = create_wall_timer(500ms, ...);
```

### Q2: å¦‚ä½•å¤„ç†"ç¼“å­˜æº¢å‡º"è­¦å‘Šï¼Ÿ
**A:** å¢åŠ é…ç½®å‚æ•°ï¼š
```yaml
max_cache_size: 5000  # é»˜è®¤1000
```

### Q3: ä¸ºä»€ä¹ˆæœ‰äº›AISæ•°æ®æœªå‘å¸ƒï¼Ÿ
**A:** å¯èƒ½åŸå› ï¼š
1. éType 1/2/3æ¶ˆæ¯ï¼ˆå¦‚Type 5é™æ€æ•°æ®ï¼‰
2. æ•°æ®æ ¡éªŒå¤±è´¥ï¼ˆæ— æ•ˆä½ç½®/MMSIï¼‰
3. å¤šç‰‡æ®µç»„åˆå¤±è´¥

æŸ¥çœ‹DEBUGæ—¥å¿—æ’æŸ¥ï¼š
```bash
ros2 run marnav_ais ais_parser_node_v2 --ros-args --log-level debug
```

### Q4: å¦‚ä½•åŒæ—¶ä½¿ç”¨V1å’ŒV2ï¼Ÿ
**A:** ä¸¤ä¸ªç‰ˆæœ¬å¯å¹¶è¡Œè¿è¡Œï¼ˆè¯é¢˜ä¸å†²çªï¼‰ï¼š
```bash
# ç»ˆç«¯1ï¼šåŸç‰ˆï¼ˆå®æ—¶å‘å¸ƒï¼‰
ros2 run marnav_ais ais_parser_node

# ç»ˆç«¯2ï¼šV2ç‰ˆï¼ˆæ‰¹é‡å‘å¸ƒï¼‰
ros2 run marnav_ais ais_parser_node_v2
```

## ğŸ“¦ ä¾èµ–é¡¹

- ROS 2 Humble/Foxy
- marnav (AISè§£ç åº“)
- libserial-dev (ä¸²å£é€šä¿¡)
- GeographicLib (åœ°ç†è®¡ç®—)
- marnav_interfaces (è‡ªå®šä¹‰æ¶ˆæ¯)

## ğŸ“ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°AISç±»å‹æ”¯æŒ

1. åœ¨ `process_position_report()` ä¸­æ·»åŠ ç±»å‹åˆ¤æ–­ï¼š
```cpp
else if (message->type() == ais::message_id::static_data_report) {
    // å¤„ç†Type 5é™æ€æ•°æ®
}
```

2. æ‰©å±• `Ais.msg` æ·»åŠ æ–°å­—æ®µ
3. é‡æ–°ç¼–è¯‘ `marnav_interfaces` å’Œ `marnav_ais`

### è‡ªå®šä¹‰æ‰¹é‡ç­–ç•¥

ä¿®æ”¹ `publish_ais_batch()` å®ç°è‡ªå®šä¹‰é€»è¾‘ï¼š
- æŒ‰MMSIåˆ†ç»„
- æŒ‰è·ç¦»è¿‡æ»¤
- æ•°æ®å»é‡

## ğŸ“„ è®¸å¯è¯

ä¸åŸ marnav_ais åŒ…ä¿æŒä¸€è‡´

## ğŸ‘¥ ç»´æŠ¤è€…

åŸºäºåŸç‰ˆé‡å†™ï¼Œä¼˜åŒ–æ‰¹é‡å‘å¸ƒåœºæ™¯

